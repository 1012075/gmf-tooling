<?xml version="1.0"?>
<project name="Automated Testing for GMF" default="all" basedir=".">
	<!-- Adjust these properties as appropriate before executing tests. During the automated build,
	     these are set based on the build configuration settings. -->
	<property name="baseLocation" value="${basedir}/../.."/>
	<property name="gmfVersion" value="1.0.0"/>
	<property name="baseos" value="win32"/>
	<property name="basews" value="win32"/>
	<property name="basearch" value="x86"/>
	<property name="testPluginVersion" value="3.1.0"/>
	<!-- Load the pluginVersions.property file generated by the build -->
	<property file="${buildRoot}/tests/pluginVersions.properties"/>

	<target name="runtests" depends="" description="Executes the junit tests for a specified plug-in.">
		<!-- Check to see if forcing qualifier context.  If so, override the version found in pluginVersions.properties -->
		<condition property="qVersion" value=".${forceContextQualifier}">
			<isset property="forceContextQualifier"/>
		</condition>
		<property name="qVersion" value="${qualifier}"/>
		<java jar="${baseLocation}/startup.jar" fork="true" failonerror="true" timeout="600000" maxmemory="1024m">
			<assertions>
				<enable/>
			</assertions>
			<arg value="-application" />
			<arg value="org.eclipse.ant.core.antRunner" />
			<arg value="-file" />
			<arg value="${basedir}/src/${testPlugin}_${gmfVersion}${qVersion}/test.xml" />
			<arg value="-logger" />
			<arg value="org.apache.tools.ant.DefaultLogger" />
			<arg value="-Dos=${baseos}" />
			<arg value="-Dws=${basews}" />
			<arg value="-Darch=${basearch}" />
			<arg value="-DtestPlugin=${testPlugin}" />
			<arg value="-Dreport=${testPlugin}" />
			<arg value="-Declipse-home=${baseLocation}" />
			<arg value="-DlibraryFile=${baseLocation}/plugins/org.eclipse.test_${testPluginVersion}/library.xml" />			
		</java>
		<move file="${baseLocation}/${testPlugin}.xml" tofile="${basedir}/testresults/xml/${testPlugin}.xml" />
	</target>

	<!-- For each, the qualifier value is what's found in generated pluginVersions.properties file. Typically, 
	     it is the build id (e.g. I20060131-0200) -->
	<target name="all" description="Runs the test.xml of the test plugins">
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.emf.clipboard.core" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.emf.clipboard.core}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.emf.commands.core" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.emf.commands.core}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.emf.core" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.emf.core}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.emf.type.core" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.emf.type.core}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.emf.type.ui" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.emf.type.ui}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.emf.ui" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.emf.ui}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.gef.ui" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.gef.ui}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.common.core" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.common.core}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.common.ui" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.common.ui}" />
		</antcall>
<!-- Possibly causes the build procedure hang up
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.common.ui.services" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.common.ui.services}" />
		</antcall>
-->		
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.common.ui.services.action" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.common.ui.services.action}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.diagram.ui" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.diagram.ui}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.draw2d.ui" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.draw2d.ui}" />
		</antcall>
		<antcall target="runtests">
			<param name="testPlugin" value="org.eclipse.gmf.tests.runtime.draw2d.ui.render" />
			<param name="qualifier" value=".${org.eclipse.gmf.tests.runtime.draw2d.ui.render}" />
		</antcall>
		<antcall target="genHtml"/>
	</target>

	<target name="genHtml" description="Generates HTML results with provided JUNIT.XSL provided">
		<style style="${basedir}/JUNIT.XSL" basedir="${basedir}/testresults/xml" destdir="${basedir}/testresults/html/" />
	</target>
</project>
