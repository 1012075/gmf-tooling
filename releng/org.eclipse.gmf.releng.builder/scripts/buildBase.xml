<?xml version="1.0"?>
<project default="main" basedir=".">
	
	<import file="build-common.xml"/>

	<macrodef name="initparams">
	   <attribute name="targetConfigTag"/>
	   <sequential>
			<cvs command="checkout -d org.eclipse.gmf.releng.target" cvsRoot="${cvs.root}"
				package="${targetRoot}" dest="${basedir}" tag="@{targetConfigTag}" />
			<property file="${basedir}/org.eclipse.gmf.releng.target/base.cfg"/>		
			<tstamp/>
			<property name="date" value="${gmfBaseDate}" />
			<property name="time" value="${gmfBaseTime}" />
			<property name="timestamp" value="${date}${time}" />
			<property name="buildType" value="${gmfBaseBuildType}" />	
			<property name="buildId" value="${gmfBaseBuildId}" />
			<property name="buildLabel" value="${gmfBaseBuildLabel}" />
	   </sequential>
	</macrodef>	
	
	<target name="checkArgs" unless="stable.target">
		<echo message="tags.properties file is required." />
		<fail/>
	</target>
	
	<target name="main" depends="checkArgs">
		<initparams targetConfigTag="${stable.target}"/>
		<antcall target="cc.cleanup"/>
		<echo message="Building GMF Base..." />
		<ant antfile="build.xml" target="main">
			<property name="component" value="base" />
			<property name="wipe" value="true" />
			<property name="cleanBase" value="true" />
			<property name="mapsCheckoutTag" value="${stable.maps}" />
			<property name="targetConfigTag" value="${stable.target}" />
			<property name="componentsTag" value="${stable.components}" />
		</ant>
		<echo message="Building GMF Base Platform..." />
		<ant antfile="build.xml" target="product">
			<property name="component" value="base-platform" />
			<property name="wipe" value="true" />
			<property name="cleanBase" value="true" />
			<property name="mapsCheckoutTag" value="${stable.maps}" />
			<property name="targetConfigTag" value="${stable.target}" />
			<property name="componentsTag" value="${stable.components}" />
		</ant>
		<antcall target="cc.publish"/>
		<antcall target="publish"/>
	</target>

	<target name="maintenance" depends="checkArgs">
		<initparams targetConfigTag="${maintenance.target}"/>
		<antcall target="cc.cleanup"/>
		<echo message="Building GMF Base..." />
		<ant antfile="build.xml" target="main">
			<property name="component" value="base" />
			<property name="wipe" value="true" />
			<property name="cleanBase" value="true" />
			<property name="mapsCheckoutTag" value="${maintenance.maps}" />
			<property name="targetConfigTag" value="${maintenance.target}" />
			<property name="componentsTag" value="${maintenance.components}" />
		</ant>
		<echo message="Building GMF Base Platform..." />
		<ant antfile="build.xml" target="product">
			<property name="component" value="base-platform" />
			<property name="wipe" value="true" />
			<property name="cleanBase" value="true" />
			<property name="mapsCheckoutTag" value="${maintenance.maps}" />
			<property name="targetConfigTag" value="${maintenance.target}" />
			<property name="componentsTag" value="${maintenance.components}" />
		</ant>
		<antcall target="cc.publish"/>
		<antcall target="publish.maintenance"/>
	</target>

	<target name="publish">
		<initparams targetConfigTag="${stable.target}"/>
		<antcall target="publish.do"/>
	</target>
		
	<target name="publish.maintenance">
		<initparams targetConfigTag="${maintenance.target}"/>
		<antcall target="publish.do"/>
	</target>
		
	<target name="publish.do">
		<property name="component" value="base" />
		<property name="buildDirectory" value="${buildRoot}/${component}"/>
		<property name="publish.xml" value="../../org.eclipse.releng.basebuilder/plugins/org.eclipse.build.tools/scripts/publish.xml" />

		<property name="indexFileName" value="index.php" />
		<property name="result" value="${artifacts}/drops/${buildLabel}" />

		<ant antfile="${basedir}/publish.base.xml" dir="${basedir}">
			<property name="dropTemplateFileName" value="${basedir}/templateFiles.base/index.php.template" />
			<property name="platformIdentifierToken" value="%platform%"/>
			<property name="platformSpecificTemplateList" value=""/>
			<property name="dropTokenList" value="%base%,%base-platform%" />
			<property name="isBuildTested" value="true" />
			<property name="testManifestFileName" value="${basedir}/templateFiles.base/testManifest.xml" />
		</ant>

		<!-- Copy the directory.txt file to destination for download page -->
		<copy file="${buildDirectory}/directory.txt" todir="${artifacts}/drops/${buildLabel}" />

		<replace file="${result}/${indexFileName}">
			<!--  Insert url for supported eclipse drop-->
			<replacefilter token="@eclipseVersion@" value="${eclipseVersion}" />
			<replacefilter token="@eclipseBuildId@" value="${eclipseBuildId}" />
			<replacefilter token="@eclipseBaseURL@" value="${eclipseBaseURL}" />
			<replacefilter token="@eclipseDownloadPage@" value="${eclipseDownloadPage}" />

			<!--  Insert url for supported EMF etc -->
			<replacefilter token="@emfUpdateVersion@" value="${emfUpdateVersion}" />
			<replacefilter token="@emfQtvAllUpdateVersion@" value="${emfQtvAllUpdateVersion}" />
			<replacefilter token="@emfUpdateSite@" value="${emfUpdateSite}" />
			
			<replacefilter token="@oclUpdateVersion@" value="${oclUpdateVersion}" />
			<replacefilter token="@oclUpdateSite@" value="${oclUpdateSite}" />

			<replacefilter token="@gefUpdateVersion@" value="${gefUpdateVersion}" />
			<replacefilter token="@gefUpdateSite@" value="${gefUpdateSite}" />

			<replacefilter token="@orbitBuildId@" value="${orbitBuildId}" />
		</replace>

		<!-- Replace the base variables to be nothing for bld-index, and the full reroute url for the main index file. -->
		<replace file="${result}/${indexFileName}" token="@base@" value="http://www.eclipse.org/downloads/download.php?file=/modeling/gmf/downloads/drops/${buildLabel}/" />
		<!-- Correct the slashes for the compilation logs on Windows -->
		<replace file="${result}/testResults.php" token="\" value="/" />
		
		<!-- Copy update jars as well -->
		<!--
		<copy todir="${buildRoot}/artifacts/updates/${buildLabel}/features">
			<fileset dir="${buildUpdateSitePath}/features" />
		</copy>
		<copy todir="${buildRoot}/artifacts/updates/${buildLabel}/plugins">
			<fileset dir="${buildUpdateSitePath}/plugins" />
		</copy>
		-->
	</target>

</project>