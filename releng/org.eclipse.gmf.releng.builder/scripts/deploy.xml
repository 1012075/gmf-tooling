<project default="main" basedir=".">

	<import file="build-common.xml"/>

	<target name="init">		
		<tstamp/>
		<property name="date" value="${DSTAMP}" />
		<property name="time" value="${TSTAMP}" />
		<property name="timestamp" value="${date}${time}" />
		<property name="buildType" value="C" />	
		<property name="buildId" value="${buildType}${date}" />
		<!--this naming convention used by php scripts on download server-->
		<property name="buildLabel" value="${buildType}-${buildId}-${timestamp}" />
		<condition property="skipUpload">
			<or>
				<!-- TODO: this should be checked for zips only
				<not>
					<available file="${buildRoot}/artifacts/${buildLabel}/testResults.php"/>
				</not>
				-->
				<not>
					<isset property="ftpUser"/>
				</not>	
				<not>
					<isset property="ftpPassword"/>
				</not>	
			</or>
		</condition>
	</target>	

	
	<target name="main">
		<antcall target="deploy.zips"/>
		<antcall target="deploy.updates.interim"/>
	</target>
	
	<target name="deploy.zips" depends="init" unless="skipUpload"> 	
		<echo message="SCP to: ${remoteDirectory}/downloads/drops/${buildLabel}"/>	
	
		<zip destfile="${buildRoot}/artifacts/drops/${buildLabel}/logs.zip">
	    	<zipfileset dir="${buildRoot}/artifacts/drops/${buildLabel}/compilelogs" prefix="compilelogs"/>
	    	<zipfileset dir="${buildRoot}/artifacts/drops/${buildLabel}/buildnotes" prefix="buildnotes"/>
	    	<zipfileset dir="${buildRoot}/artifacts/drops/${buildLabel}/testresults" prefix="testresults"/>
	  	</zip>
   
		<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="mkdir ${remoteDirectory}/downloads/drops/${buildLabel}" failonerror="false"/>

		<scp trust="yes" todir="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/downloads/drops/${buildLabel}">
	    <fileset dir="${buildRoot}/artifacts/drops/${buildLabel}">
	    	<include name="*.php"/>
	    	<include name="*.gif"/>
	    	<include name="files.count"/>
	    	<include name="*.txt"/>
	    	<include name="*.zip"/>
	    </fileset>
	  	</scp>
  
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="unzip ${remoteDirectory}/downloads/drops/${buildLabel}/logs.zip -d ${remoteDirectory}/downloads/drops/${buildLabel}"/>
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="rm ${remoteDirectory}/downloads/drops/${buildLabel}/logs.zip"/>
		<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="chmod -R 775 ${remoteDirectory}/downloads/drops/${buildLabel}"/>
	</target>
	
	<target name="deploy.updates.interim" depends="init"> 	
		<ant antfile="updatesite.local.xml" target="init.site">
			<property name="updatesite.name" value="interim"/>
		</ant> 
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-sdk-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-sdk-experimental-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-tests-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-tests-experimental-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<ant antfile="deploy.updates.xml" target="deploy.local">
			<property name="updates.path" value="${buildRoot}/uploadsite/eclipse"/>
			<property name="updatesite.name" value="interim"/>
			<property name="features.list" value="*"/>
		</ant>
		<ant antfile="updatesite.local.xml" target="rsync.up">
			<property name="updatesite.name" value="interim"/>
		</ant>
		<delete dir="${buildRoot}/uploadsite" failonerror="false"/>
	</target>
	
	<target name="deploy.updates.milestone" depends="init"> 	
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-sdk-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-sdk-experimental-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-tests-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-tests-experimental-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<ant antfile="updatesite.local.xml" target="rsync.down">
			<property name="updatesite.name" value="milestone"/>
		</ant>
		<ant antfile="deploy.updates.xml" target="deploy.local">
			<property name="updates.path" value="${buildRoot}/uploadsite/eclipse"/>
			<property name="updatesite.name" value="milestone"/>
			<property name="features.list" value="*"/>
		</ant>
		<ant antfile="updatesite.local.xml" target="rsync.up">
			<property name="updatesite.name" value="milestone"/>
		</ant>
		<delete dir="${buildRoot}/uploadsite" failonerror="false"/>
	</target>
	
	<target name="deploy.updates.release" depends="init"> 	
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-sdk-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-sdk-experimental-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-tests-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-tests-experimental-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<ant antfile="updatesite.local.xml" target="rsync.down">
			<property name="updatesite.name" value="releases"/>
		</ant>
		<ant antfile="deploy.updates.xml" target="deploy.local">
			<property name="updates.path" value="${buildRoot}/uploadsite/eclipse"/>
			<property name="updatesite.name" value="releases"/>
			<property name="features.list" value="*"/>
		</ant>
		<ant antfile="updatesite.local.xml" target="rsync.up">
			<property name="updatesite.name" value="releases"/>
		</ant>
		<delete dir="${buildRoot}/uploadsite" failonerror="false"/>
	</target>

	<target name="deploy.updates.europa" depends="init"> 	
		<unzip src="${buildRoot}/artifacts/updates/${buildLabel}/GMF-europa-${buildId}.zip"
			dest="${buildRoot}/uploadsite"/>
		<!-- PLACEHOLDER: Downloading EMTF plugins from the update site -->
		<ant antfile="updatesite.local.xml" target="rsync.down">
			<property name="updatesite.name" value="europa"/>
		</ant>
		<ant antfile="deploy.updates.xml" target="deploy.local">
			<property name="updates.path" value="${buildRoot}/uploadsite/eclipse"/>
			<property name="updatesite.name" value="europa"/>
			<property name="features.list" value="*europa*"/>
		</ant>
		<ant antfile="updatesite.local.xml" target="rsync.up">
			<property name="updatesite.name" value="europa"/>
		</ant>
		<delete dir="${buildRoot}/uploadsite" failonerror="false"/>
	</target>

	<target name="init.base">
		<cvs command="checkout -d org.eclipse.gmf.releng.target" cvsRoot="${cvs.root}"
			package="${targetRoot}" dest="${basedir}" tag="${stable.target}" />
		<property file="${basedir}/org.eclipse.gmf.releng.target/build.cfg"/>		
		<tstamp/>
		<property name="date" value="${gmfBaseDate}" />
		<property name="time" value="${gmfBaseTime}" />
		<property name="timestamp" value="${date}${time}" />
		<property name="buildType" value="${gmfBaseBuildType}" />	
		<property name="buildId" value="${gmfBaseBuildId}" />
		<property name="buildLabel" value="${gmfBaseBuildLabel}" />
	</target>
		
	<target name="deploy.base" depends="init.base">
		<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="mkdir ${remoteDirectory}/downloads/drops/${buildLabel}" failonerror="false"/>
		<exec executable="rsync">
			<arg value="-var"/>
			<arg value="--delete"/>
			<arg value="${buildRoot}/artifacts/drops/${buildLabel}"/>
			<arg value="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/downloads/drops/${buildLabel}/"/>
		</exec>	
		<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="chmod -R 775 ${remoteDirectory}/downloads/drops/${buildLabel}"/>
	</target>	

</project>
