<project default="main" basedir=".">

	<target name="init">		
		<delete file="label.properties" />
		<ant antfile="build.xml" target="create.label.properties" />
		<!-- The tags.properties file contains tags for map files containing 'stable' and 'integration' config -->
		<property file="tags.properties"/>
		<property file="label.properties"/>
		<property file="build.properties"/>
		<condition property="skipUpload">
			<or>
				<not>
					<available file="${buildRoot}/artifacts/${buildLabel}/testResults.php"/>
				</not>
				<not>
					<isset property="ftpUser"/>
				</not>	
				<not>
					<isset property="ftpPassword"/>
				</not>	
			</or>
		</condition>
	</target>	

	
	<target name="main">
		<antcall target="deploy.zips"/>
		<antcall target="deploy.updates.interim"/>
	</target>
	
	<target name="deploy.zips" depends="init" unless="skipUpload"> 	
		<echo message="SCP to: ${remoteDirectory}/downloads/drops/${buildLabel}"/>	
	
		<zip destfile="${buildRoot}/artifacts/${buildLabel}/logs.zip">
	    	<zipfileset dir="${buildRoot}/artifacts/${buildLabel}/compilelogs" prefix="compilelogs"/>
	    	<zipfileset dir="${buildRoot}/artifacts/${buildLabel}/buildnotes" prefix="buildnotes"/>
	    	<zipfileset dir="${buildRoot}/artifacts/${buildLabel}/testresults" prefix="testresults"/>
	  	</zip>
   
		<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="mkdir ${remoteDirectory}/downloads/drops/${buildLabel}"/>

		<scp trust="yes" todir="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/downloads/drops/${buildLabel}">
	    <fileset dir="${buildRoot}/artifacts/${buildLabel}">
	    	<include name="*.php"/>
	    	<include name="*.gif"/>
	    	<include name="files.count"/>
	    	<include name="*.txt"/>
	    	<include name="*.zip"/>
	    </fileset>
	  	</scp>
  
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="unzip ${remoteDirectory}/downloads/drops/${buildLabel}/logs.zip -d ${remoteDirectory}/downloads/drops/${buildLabel}"/>
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="rm ${remoteDirectory}/downloads/drops/${buildLabel}/logs.zip"/>
		<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="chmod -R 775 ${remoteDirectory}/downloads/drops/${buildLabel}"/>
	</target>
	
	<target name="deploy.updates.interim" depends="init" unless="skipUpload"> 	
		<antcall target="init.site">
			<param name="updateSiteName" value="interim"/>
		</antcall>
		<antcall target="deploy.updates">
			<param name="updateSiteName" value="interim"/>
			<param name="excludes" value="org.eclipse.gmf.callisto"/>
		</antcall>
	</target>
	
	<target name="deploy.updates.milestone" depends="init" unless="skipUpload"> 	
		<antcall target="deploy.updates">
			<param name="updateSiteName" value="milestone"/>
			<param name="excludes" value="org.eclipse.gmf.callisto"/>
		</antcall>
	</target>
	
	<target name="deploy.updates.callisto" depends="init" unless="skipUpload"> 	
		<!-- Downloading EMTF plugins from the update site -->
		<antcall target="download.EMFT"/>
		<antcall target="deploy.updates">
			<param name="updateSiteName" value="callisto"/>
			<param name="includes" value="org.eclipse.gmf.callisto"/>
		</antcall>
	</target>

	<!-- @param updateSiteName -->
	<target name="deploy.updates" depends="init" if="updateSiteName"> 	
		<echo message="Updating update site ${updateSiteName} ..."/>
	  	<scp trust="yes" file="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/update-site/${updateSiteName}/site.xml"
	  		localTodir="${buildRoot}/artifacts/updates/${buildLabel}/"/>
	  	<antcall target= "build.site.xml">
			<param name="siteXml" value="${buildRoot}/artifacts/updates/${buildLabel}/site.xml"/>
	  	</antcall>	
		<scp trust="yes" todir="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/update-site/${updateSiteName}/features">
	    	<fileset dir="${buildRoot}/artifacts/updates/${buildLabel}/features">
	    		<include name="*.jar"/>
	    	</fileset>
	  	</scp>
	  	<scp trust="yes" todir="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/update-site/${updateSiteName}/plugins">
	    	<fileset dir="${buildRoot}/artifacts/updates/${buildLabel}/plugins">
	    		<include name="*.jar"/>
	    	</fileset>
	  	</scp>
		<scp trust="yes" todir="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/update-site/${updateSiteName}"
	    	file="${buildRoot}/artifacts/updates/${buildLabel}/site.xml"/>
	</target>
	
	<!-- @param updateSiteName -->
	<target name="init.site" depends="init" if="updateSiteName">		
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="rm -dfr ${remoteDirectory}/update-site/${updateSiteName}"/>
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="mkdir ${remoteDirectory}/update-site/${updateSiteName}"/>
		<cvs cvsRoot=":pserver:anonymous@dev.eclipse.org:/cvsroot/technology" command="export -r HEAD -d updates" package="org.eclipse.gmf/releng/org.eclipse.gmf.updatesite" dest="${buildRoot}" />
		<scp trust="yes" todir="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/update-site/${updateSiteName}">
	    	<fileset dir="${buildRoot}/updates">
	    		<include name="*.*"/>
	    	</fileset>
	  	</scp>
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="mkdir ${remoteDirectory}/update-site/${updateSiteName}/web"/>
		<scp trust="yes" todir="${ftpUser}:${ftpPassword}@download1.eclipse.org:${remoteDirectory}/update-site/${updateSiteName}/web">
	    	<fileset dir="${buildRoot}/updates/web">
	    		<include name="*.*"/>
	    	</fileset>
	  	</scp>
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="mkdir ${remoteDirectory}/update-site/${updateSiteName}/features"/>
	  	<sshexec trust="yes" host="download1.eclipse.org" username="${ftpUser}" password="${ftpPassword}" command="mkdir ${remoteDirectory}/update-site/${updateSiteName}/plugins"/>
	</target>
	
	<target name="build.site.xml">                                                                                                
        <echo message="Building site.xml"/>                                                                             
        <java jar="../../org.eclipse.releng.basebuilder/startup.jar" fork="true" failonerror="false">                   
            <arg value="-consolelog"/>                                                                                  
            <arg value="-application"/>                                                                                 
            <arg value="org.eclipse.gmf.releng.updateSiteBuilder"/>                                                     
            <arg value="-build"/>                                                                                       
            <arg value="${buildLabel}"/>                                                                                
            <arg value="-site"/>                                                                                        
            <arg value="${buildRoot}/artifacts/updates/${buildLabel}"/>                                                                       
            <arg value="-sitexml"/>                                                                                     
            <arg value="${siteXml}"/>
        	   <arg name="-exclude" value="${excludes}"/>
        	   <arg name="-include" value="${includes}"/>       	
        </java>                                                                                                         
    </target>  
		
	<target name="download.EMFT">
		<echo message="Adding EMFT to the update site"/>
		<cvs command="checkout -d org.eclipse.gmf.releng.target" cvsRoot=":pserver:anonymous@dev.eclipse.org/cvsroot/technology" 
			package="org.eclipse.gmf/releng/org.eclipse.gmf.releng.target" dest="${buildRoot}/maps" tag="${fetchTag}" />
		<property file="${buildRoot}/maps/org.eclipse.gmf.releng.target/build.cfg"/>		
		<property name="baseLocation" value="../../org.eclipse.releng.basebuilder"/>
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${emfOCLFeatureId}" />
			<property name="version" value="${emfOCLUpdateVersion}" />
			<property name="updateSite" value="${emfOCLUpdateSite}" />
			<property name="mirror" value="${buildRoot}/artifacts/updates/${buildLabel}" />
		</ant>
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${emfQueryFeatureId}" />
			<property name="version" value="${emfQueryUpdateVersion}" />
			<property name="updateSite" value="${emfQueryUpdateSite}" />
			<property name="mirror" value="${buildRoot}/artifacts/updates/${buildLabel}" />
		</ant>
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${emfQueryOCLFeatureId}" />
			<property name="version" value="${emfQueryOCLUpdateVersion}" />
			<property name="updateSite" value="${emfQueryOCLUpdateSite}" />
			<property name="mirror" value="${buildRoot}/artifacts/updates/${buildLabel}" />
		</ant>
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${emfValidationFeatureId}" />
			<property name="version" value="${emfValidationUpdateVersion}" />
			<property name="updateSite" value="${emfValidationUpdateSite}" />
			<property name="mirror" value="${buildRoot}/artifacts/updates/${buildLabel}" />
		</ant>
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${emfValidationOCLFeatureId}" />
			<property name="version" value="${emfValidationOCLUpdateVersion}" />
			<property name="updateSite" value="${emfValidationOCLUpdateSite}" />
			<property name="mirror" value="${buildRoot}/artifacts/updates/${buildLabel}" />
		</ant>
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${emfTransactionFeatureId}" />
			<property name="version" value="${emfTransactionUpdateVersion}" />
			<property name="updateSite" value="${emfTransactionUpdateSite}" />
			<property name="mirror" value="${buildRoot}/artifacts/updates/${buildLabel}" />
		</ant>
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${emfWorkspaceFeatureId}" />
			<property name="version" value="${emfWorkspaceUpdateVersion}" />
			<property name="updateSite" value="${emfWorkspaceUpdateSite}" />
			<property name="mirror" value="${buildRoot}/artifacts/updates/${buildLabel}" />
		</ant>
	</target>
</project>
