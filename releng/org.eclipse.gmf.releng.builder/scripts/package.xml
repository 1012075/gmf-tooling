<project name="Run update site optimization steps">
	
	<target name="pack200" if="pack200">
		<property name="packtmp" value="${buildDirectory}/packtmp" />
		<mkdir dir="${packtmp}" />	
		<move file="${buildDirectory}/${buildLabel}/${archiveName}" tofile="${packtmp}/${archiveName}"/>
		
	     <java jar="${buildRoot}/eclipse/startup.jar"
	           fork="true"
        	   jvm="${java15-home}/bin/java"
	           failonerror="true"
	           maxmemory="128m"
			   dir="${buildDirectory}">
	         <arg line="-application org.eclipse.update.core.siteOptimizer"/>
	         <arg line="-jarProcessor -outputDir ${buildLabel} -pack -repack ${packtmp}/${archiveName}"/>
	       </java>
	
		<delete dir="${packtmp}" />
	</target>
	
	<target name="unpackUpdateJarsForPackaging">
		<property file="${buildDirectory}/maps/org.eclipse.gmf.releng.target/build.cfg"/>		
		<property name="tmpsite" value="${buildDirectory}/tmpsite" />
		<mkdir dir="${tmpsite}/new/eclipse/features" />
		<mkdir dir="${tmpsite}/new/eclipse/plugins" />
		<exec executable="unzip" dir="${artifacts}/${buildLabel}">
			<arg line="-q ${archiveName} -d ${tmpsite}" />
		</exec>
		<unpackUpdateJars site="${tmpsite}/eclipse" output="${tmpsite}/new/eclipse"/>

		<!-- package Batik -->
		<mkdir dir="${tmpsite}/batik" />
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${batikFeatureId}" />
			<property name="version" value="${batikUpdateVersion}" />
			<property name="updateSite" value="${batikUpdateSite}" />
			<property name="mirror" value="${tmpsite}/batik" />
		</ant>		
		<unpackUpdateJars site="${tmpsite}/batik" output="${tmpsite}/new/eclipse"/>
				
		<zip destfile="${artifacts}/${buildLabel}/${archiveName}"
			basedir="${tmpsite}/new"
	  	/>
		<move file="${tmpsite}/eclipse" tofile="${buildUpdateSitePath}"/>
		<delete dir="${tmpsite}"/>
	</target>
	
</project>
