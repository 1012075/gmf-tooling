<project name="Run update site optimization steps">
	
	<target name="pack200" if="pack200">
		<property name="packtmp" value="${buildDirectory}/packtmp" />
		<mkdir dir="${packtmp}" />	
		<move file="${buildDirectory}/${buildLabel}/${archiveName}" tofile="${packtmp}/${archiveName}"/>
		
	     <java jar="../../org.eclipse.releng.basebuilder/plugins/org.eclipse.equinox.launcher.jar"
	           fork="true"
        	   jvm="${java15-home}/bin/java"
	           failonerror="true"
	           maxmemory="128m"
			   dir="${buildDirectory}">
	         <arg line="-application org.eclipse.update.core.siteOptimizer"/>
	         <arg line="-jarProcessor -outputDir ${buildLabel} -pack -repack ${packtmp}/${archiveName}"/>
	       </java>
	
		<delete dir="${packtmp}" />
	</target>
	
	<target name="unpackUpdateJarsForPackaging">
		<property name="tmpsite" value="${buildDirectory}/tmpsite" />
		<mkdir dir="${tmpsite}/new/eclipse/features" />
		<mkdir dir="${tmpsite}/new/eclipse/plugins" />
		<exec executable="unzip" dir="${artifacts}/${buildLabel}">
			<arg line="-q ${archiveName} -d ${tmpsite}" />
		</exec>
		<copy todir="${buildUpdateSitePath}">
		    <fileset dir="${tmpsite}/eclipse"/>
		</copy>

		<unpackUpdateJars site="${tmpsite}/eclipse" output="${tmpsite}/new/eclipse"/>
		<antcall target="packageBatik"/>
		<antcall target="packageXerces"/>
		<antcall target="packageLicenseFiles"/>
		<zip destfile="${artifacts}/${buildLabel}/${archiveName}"
			basedir="${tmpsite}/new"
	  	/>
		<delete dir="${tmpsite}"/>
	</target>
	
	<target name="packageBatik" if="packageBatik">
		<property file="${buildDirectory}/maps/org.eclipse.gmf.releng.target/build.cfg"/>		
		<mkdir dir="${tmpsite}/batik" />
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${batikFeatureId}" />
			<property name="version" value="${batikUpdateVersion}" />
			<property name="updateSite" value="${batikUpdateSite}" />
			<property name="mirror" value="${tmpsite}/batik" />
		</ant>		
		<unpackUpdateJars site="${tmpsite}/batik" output="${tmpsite}/new/eclipse"/>
		<delete dir="${tmpsite}/batik"/>
	</target>
	
	<target name="packageXerces" if="packageXerces">
		<property file="${buildDirectory}/maps/org.eclipse.gmf.releng.target/build.cfg"/>		
		<mkdir dir="${tmpsite}/xerces" />
		<ant antfile="${scripts}/update.xml" target="mirror2">
			<property name="featureId" value="${xercesFeatureId}" />
			<property name="version" value="${xercesUpdateVersion}" />
			<property name="updateSite" value="${xercesUpdateSite}" />
			<property name="mirror" value="${tmpsite}/xerces" />
		</ant>		
		<unpackUpdateJars site="${tmpsite}/xerces" output="${tmpsite}/new/eclipse"/>
		<delete dir="${tmpsite}/xerces"/>
	</target>
	
	<target name="packageLicenseFiles">
		<copy file="${buildRoot}/eclipse/epl-v10.html" todir="${tmpsite}/new/eclipse"/>
		<copy file="${buildRoot}/eclipse/notice.html" todir="${tmpsite}/new/eclipse"/>
	</target>
	
</project>
