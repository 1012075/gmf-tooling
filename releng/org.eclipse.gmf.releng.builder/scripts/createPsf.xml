<?xml version="1.0"?>
<project xmlns:antcontrib="antlib:net.sf.antcontrib" default="main" basedir=".">

	<import file="build-common.xml"/>
	<taskdef uri="antlib:net.sf.antcontrib"
	    resource="net/sf/antcontrib/antlib.xml"
	    classpath="${lib}/ant-contrib.jar"/>	
	
	<target name="init">
	    <property name="mapsCheckoutTag" value="HEAD"/>
	    <property name="psfFile" value="gmf.psf"/>
	</target>    

	<target name="main" depends="init">
	    <cvs command="checkout -d tmp" cvsRoot="${cvs.root}" package="${mapsRoot}" dest="${basedir}" tag="${mapsCheckoutTag}" />
	    <fileset dir="${basedir}/tmp/maps" id="mapfiles">
        	<include name="**/*.map"/>
	    </fileset>
	    <pathconvert pathsep="," property="mapfiles.list" refid="mapfiles"/>	    
	    <antcontrib:for list="${mapfiles.list}" param="mapfile">
			<sequential>
		    	<property file="@{mapfile}"/>
			</sequential>	
	    </antcontrib:for>

	    <antcontrib:propertyselector property="features.list"
		    delimiter=","
		    match="feature@(.*)"
		    select="\1"
		    casesensitive="false" />
	    <antcontrib:propertyselector property="plugins.list"
		    delimiter=","
		    match="plugin@(.*)"
		    select="\1"
		    casesensitive="false" />

		<echo file="${psfFile}"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<psf version="2.0">
	<provider id="org.eclipse.team.cvs.core.cvsnature">]]></echo>
	
	    <antcontrib:for list="${features.list}" param="feature.id">
			<sequential>
				<antcontrib:var name="feature.id.id" value="@{feature.id}"/>
				<antcontrib:propertycopy override="true" property="feature.params.list" from="feature@${feature.id.id}"/>
				<antcontrib:var name="counter" value="0"/>
				<property name="sum" value="+"/>
				<antcontrib:for list="${feature.params.list}" param="feature.param">
					<sequential>
						<antcontrib:var	 name="feature.param.${counter}" value="@{feature.param}"/>
					    <antcontrib:math result="counter" operand1="${counter}" operation="+" operand2="1" datatype="int"/>
					</sequential>
				</antcontrib:for>
				<antcontrib:var name="feature.version" value="${feature.param.0}"/>
				<antcontrib:var name="feature.cvsroot" value="${feature.param.1}"/>
				<antcontrib:var name="feature.cvspath" value="${feature.param.2}"/>
				<antcontrib:var name="feature.project" value="@{feature.id}-feature"/>
				<echo file="${psfFile}" append="true">
		<![CDATA[<project reference="1.0,]]>${feature.cvsroot},${feature.cvspath},${feature.project},${feature.version}"<![CDATA[/>]]></echo>
			</sequential>	
	    </antcontrib:for>

	    <antcontrib:for list="${plugins.list}" param="plugin.id">
			<sequential>
				<antcontrib:var name="plugin.id.id" value="@{plugin.id}"/>
				<antcontrib:propertycopy override="true" property="plugin.params.list" from="plugin@${plugin.id.id}"/>
				<antcontrib:var name="counter" value="0"/>
				<property name="sum" value="+"/>
				<antcontrib:for list="${plugin.params.list}" param="plugin.param">
					<sequential>
						<antcontrib:var	 name="plugin.param.${counter}" value="@{plugin.param}"/>
					    <antcontrib:math result="counter" operand1="${counter}" operation="+" operand2="1" datatype="int"/>
					</sequential>
				</antcontrib:for>
				<antcontrib:var name="plugin.version" value="${plugin.param.0}"/>
				<antcontrib:var name="plugin.cvsroot" value="${plugin.param.1}"/>
				<antcontrib:var name="plugin.cvspath" value="${plugin.param.2}"/>
				<antcontrib:var name="plugin.project" value="@{plugin.id}"/>
				<echo file="${psfFile}" append="true">
		<![CDATA[<project reference="1.0,]]>${plugin.cvsroot},${plugin.cvspath},${plugin.project},${plugin.version}"<![CDATA[/>]]></echo>
			</sequential>	
	    </antcontrib:for>


		<echo file="${psfFile}" append="true">
	<![CDATA[</provider>]]>
<![CDATA[</psf>]]></echo>
		
	</target>

<!--
	<macrodef name="increment">
		<attribute name="counter"/>
		<sequential>
			
		</sequential>
	</macrodef>		
		
-->
</project>	