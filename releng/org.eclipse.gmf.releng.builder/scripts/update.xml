<?xml version="1.0"?>
<project name="project" default="">

	<condition property="mirrorAvailable">
		<http url="${updatesite.local.url}/requirements/site.xml"/>
	</condition>
	<condition property="usingMirror">
		<and>
			<isset property="mirrorAvailable"/>
			<isset property="useMirror"/>
		</and>
	</condition>

	<!-- Mirror will check for current install to avoid unnecessary downloads. -->
	<target name="install" description="Install a feature using the update manager.">		
		<ant antfile="${scripts}/updatesite.local.xml" target="mirror"/>
		<!-- TODO: check on success of mirror and default to install from remote -->
		<antcall target="install.local"/>
		<antcall target="install.remote"/>
	</target>
	
	<target name="install.local" if="usingMirror">
		<echo message="Installing ${featureId} ${version} locally from ${updatesite.local.url}/${updatesite.name}"/>
		<java jar="${baseLocation}/plugins/${equinoxLauncherJar}" fork="true" failonerror="false">
			<arg value="-application"/>
			<arg value="org.eclipse.update.core.standaloneUpdate"/>			
			<arg value="-command"/>
			<arg value="install"/>
			<arg value="-featureId"/>
			<arg value="${featureId}"/>
			<arg value="-version"/>
			<arg value="${version}"/>
			<arg value="-from"/>
			<arg value="${updatesite.local.url}/${updatesite.name}"/>
		</java>
	</target>
	
	<target name="install.remote" unless="usingMirror">
		<echo message="Installing ${featureId} ${version} remotely from ${from.updatesite}"/>
		<java jar="${baseLocation}/plugins/${equinoxLauncherJar}" fork="true" failonerror="false">
			<arg value="-application"/>
			<arg value="org.eclipse.update.core.standaloneUpdate"/>			
			<arg value="-command"/>
			<arg value="install"/>
			<arg value="-featureId"/>
			<arg value="${featureId}"/>
			<arg value="-version"/>
			<arg value="${version}"/>
			<arg value="-from"/>
			<arg value="${from.updatesite}"/>
		</java>
	</target>
	
	<target name="uninstall" if="usingMirror">
		<!-- First, must disable the feature -->
		<echo message="Disabling ${featureId} ${version}"/>
		<java jar="${baseLocation}/plugins/${equinoxLauncherJar}" fork="true" failonerror="false">
			<arg value="-application"/>
			<arg value="org.eclipse.update.core.standaloneUpdate"/>			
			<arg value="-command"/>
			<arg value="disable"/>
			<arg value="-featureId"/>
			<arg value="${featureId}"/>
			<arg value="-version"/>
			<arg value="${version}"/>
		</java>
		<!-- Now, uninstall -->
		<echo message="Uninstalling ${featureId} ${version}"/>
		<java jar="${baseLocation}/plugins/${equinoxLauncherJar}" fork="true" failonerror="false">
			<arg value="-application"/>
			<arg value="org.eclipse.update.core.standaloneUpdate"/>			
			<arg value="-command"/>
			<arg value="uninstall"/>
			<arg value="-featureId"/>
			<arg value="${featureId}"/>
			<arg value="-version"/>
			<arg value="${version}"/>
		</java>		
	</target>
	
	<target name="mirror">
		<echo message="Mirroring ${featureId} ${version} from ${from.updatesite}"/>
		<java jar="${equinox.launcher.jar}" fork="true" failonerror="false">
			<arg value="-application"/>
			<arg value="org.eclipse.update.core.standaloneUpdate"/>			
			<arg value="-command"/>
			<arg value="mirror"/>
			<arg value="-featureId"/>
			<arg value="${featureId}"/>
			<arg value="-version"/>
			<arg value="${version}"/>
			<arg value="-from"/>
			<arg value="${from.updatesite}"/>
			<arg value="-to"/>
			<arg value="${to.updatesite}"/>
		</java>
	</target>	
	
</project>

